name: build

on: [push, pull_request]

jobs:
  latex:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up TeX Live
      uses: teatimeguest/setup-texlive-action@v2
      with:
        packages: >-
          scheme-full
          latexmk
          biber
    - name: Compile PDF using XeLaTeX
      id: build_pdf
      continue-on-error: true
      run: |
        cd paper
        latexmk -xelatex -file-line-error -interaction=nonstopmode main.tex

    - name: Show LaTeX log on failure
      if: steps.build_pdf.outcome == 'failure'
      run: cat paper/main.log || true

    - name: Upload LaTeX log
      if: steps.build_pdf.outcome == 'failure'
      uses: actions/upload-artifact@v3
      with:
        name: latex-log
        path: paper/main.log

    - name: Upload PDF
      if: steps.build_pdf.outcome == 'success'
      uses: actions/upload-artifact@v3
      with:
        name: rbt-paper
        path: paper/main.pdf

    - name: Fail job if LaTeX failed
      if: steps.build_pdf.outcome == 'failure'
      run: exit 1

  # Notebooks job disabled until notebooks directory is ready.

  # notebooks:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v3
  #   - uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.11'
  #   - name: Install deps
  #     run: pip install nbmake matplotlib numpy
  #   - name: Re-run notebooks
  #     run: pytest --nbmake notebooks/ 