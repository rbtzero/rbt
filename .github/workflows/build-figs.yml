name: Build notebook figures
on:
  workflow_dispatch:            # run only when you press the button

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (LFS on)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Jupyter & libs
        run: |
          pip install --quiet jupyter nbconvert numpy scipy matplotlib pandas plotly

      - name: Install Inkscape
        run: |
          sudo apt-get update -y
          sudo apt-get install -y inkscape

      - name: Execute notebooks
        run: |
          set -e
          shopt -s nullglob
          for nb in notebooks/*.ipynb; do
            echo "â–¶ $nb"
            jupyter nbconvert --to notebook --execute "$nb" --inplace
          done

      - name: Export vector diagrams
        run: |
          inkscape --export-type=pdf design/axiom_flow.drawio  --export-filename=paper/figs/axiom_flow.pdf
          inkscape --export-type=pdf design/number_tower.svg   --export-filename=paper/figs/number_tower.pdf
          inkscape --export-type=pdf design/tests_overview.svg --export-filename=paper/figs/tests_overview.pdf

      - name: Commit regenerated figures
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: regenerate notebook figures & diagrams"
          file_pattern: |
            notebooks/*.ipynb
            paper/figs/*.pdf
